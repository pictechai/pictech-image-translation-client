const canvasContainer=document.getElementById("canvas-container"),containerWidth=canvasContainer.clientWidth,containerHeight=canvasContainer.clientHeight,canvas=new fabric.Canvas("canvas",{width:containerWidth,height:containerHeight,backgroundColor:"#eaeaea",preserveObjectStacking:!0,imageSmoothingEnabled:!1,selection:!0});canvas.getElement().style.borderRadius="12px",canvas.getSelectionElement().style.borderRadius="12px";const textEditorPanel=document.getElementById("text-editor-panel"),textContentInput=document.getElementById("text-content-input"),fontFamilySelect=document.getElementById("font-family-select"),fontSizeInput=document.getElementById("font-size-input"),lineHeightInput=document.getElementById("line-height-input"),fontColorInput=document.getElementById("font-color-input"),colorPreview=document.getElementById("color-preview"),boldBtn=document.getElementById("font-bold-btn"),alignCenterBtn=document.getElementById("align-center-btn"),loadingOverlay=document.getElementById("loading-overlay"),loadingText=document.getElementById("loading-text");let undoStack=[],redoStack=[],initialState=null,sketch=null,isLoading=!1,isSavingState=!1,finalImage=null,inpaintingImage=null,isDragging=!1,lastPosX=0,lastPosY=0,finalImageClone=null,transparentRect=null,restoreGroup=null,originalFilename="edited_image.png",lastResultData=null,isDraggingPanel=!1,panelStartX=0,panelStartY=0,panelLeft=0,panelTop=0,lastActiveText=null;function showLoadingOverlayPic(e){loadingText.textContent=e,loadingOverlay.style.display="flex"}function hideLoadingOverlayPic(){loadingOverlay.style.display="none"}async function loadFromAPI(e){canvas.clear(),showLoadingOverlayPic("正在加载图片..."),lastResultData=e;const{InPaintingUrl:t,SourceUrl:n,TemplateJson:o}=e.Data||{};originalInpaintingUrl=t;const a=[];if(n){try{const e=n.substring(n.lastIndexOf("/")+1).split("?")[0];e&&(originalFilename=e,console.log(`[成功] 已将导出文件名设置为源文件名: ${originalFilename}`))}catch(e){console.error("解析源文件名失败，将使用默认文件名。",e),originalFilename="edited_image.png"}a.push(new Promise(e=>{fabric.Image.fromURL(n,t=>{finalImage=t,t.set({crossOrigin:"anonymous",id:"final-image",selectable:!1,evented:!1}),canvas.add(finalImage),e()},{crossOrigin:"anonymous"})}))}t&&a.push(new Promise(e=>{fabric.Image.fromURL(t,t=>{inpaintingImage=t,t.set({crossOrigin:"anonymous",id:"inpainting-image",selectable:!1,evented:!1}),canvas.add(inpaintingImage),e()},{crossOrigin:"anonymous"})})),await Promise.all(a),finalImage&&canvas.sendToBack(finalImage),inpaintingImage&&canvas.bringToFront(inpaintingImage),o&&"{ .}"!==o?(await loadFromJSON(o,!0),saveOriginalTextLayers()):saveState(),hideLoadingOverlayPic()}function populateFontSelector(){fontFamilySelect.innerHTML="",FONT_LIST.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.name,fontFamilySelect.appendChild(t)})}const FONT_URL_MAP={},FONT_LIST=[{name:"默认字体",value:"Arial, sans-serif"},{name:"思源黑体",value:"Noto Sans SC, sans-serif"},{name:"思源宋体",value:"Noto Serif SC, serif"},{name:"阿里普惠体",value:"alibaba-puhuiti, sans-serif"},{name:"AdventProBold",value:"Advent Pro, sans-serif"},{name:"Segoe UI",value:"Segoe UI, sans-serif",file:null},{name:"Calibri",value:"Calibri, sans-serif",file:null},{name:"Cambria",value:"Cambria, serif",file:null},{name:"Lucida Console",value:"Lucida Console, monospace",file:null},{name:"Menlo",value:"Menlo, monospace",file:null},{name:"SF Pro",value:"-apple-system, BlinkMacSystemFont, sans-serif",file:null},{name:"Times New Roman",value:"Times New Roman, serif",file:null},{name:"Georgia",value:"Georgia, serif",file:null},{name:"Verdana",value:"Verdana, sans-serif",file:null},{name:"Tahoma",value:"Tahoma, sans-serif",file:null},{name:"Trebuchet MS",value:"Trebuchet MS, sans-serif",file:null},{name:"Courier New",value:"Courier New, monospace",file:null}];function createCustomClass(){fabric.FImage=fabric.util.createClass(fabric.Group,{type:"f-image",initialize:function(e,t){t=t||{},this.callSuper("initialize",e,t),this.set({id:t.id||"",imageBorder:t.imageBorder||{},selectable:!1!==t.selectable,hasControls:!1!==t.hasControls,evented:!1!==t.evented})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{id:this.id,imageBorder:this.imageBorder})}}),fabric.FImage.fromObject=function(e,t){fabric.util.enlivenObjects(e.objects,function(n){const o=fabric.util.object.clone(e);delete o.objects,t&&t(new fabric.FImage(n,o))})},fabric.FText=fabric.util.createClass(fabric.Textbox,{type:"f-text",initialize:function(e,t){t=t||{},this.callSuper("initialize",e,t),this.set({id:t.id||fabric.util.getRandomInt(1,1e4).toString(),fontFamily:t.fontFamily||"Noto Sans SC, sans-serif",lineHeight:t.lineHeight||1.3,splitByGrapheme:!0,editable:!1,borderColor:"rgba(66, 153, 225, 0.7)",borderDashArray:[5,5],cornerColor:"white",cornerStrokeColor:"rgba(66, 153, 225, 1)",cornerStyle:"circle",borderScaleFactor:2.5,transparentCorners:!1,cornerSize:14,padding:10})},toObject:function(){return fabric.util.object.extend(this.callSuper("toObject"),{id:this.id,pathAlign:this.pathAlign,minWidth:this.minWidth,splitByGrapheme:this.splitByGrapheme,editable:this.editable})}}),fabric.FText.fromObject=function(e,t){const n=fabric.util.object.clone(e);n.selectable=!0,n.hasControls=!0,n.evented=!0,t&&t(new fabric.FText(e.text,n))}}createCustomClass();const deleteIconSvg='\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">\n  <line x1="18" y1="6" x2="6" y2="18"></line>\n  <line x1="6" y1="6" x2="18" y2="18"></line>\n</svg>\n',deleteIcon="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(deleteIconSvg),img=document.createElement("img");function deleteObject(e,t){const n=t.target,o=n.canvas;return o.remove(n),o.requestRenderAll(),saveState(),!0}function renderDeleteIcon(e,t,n,o,a){const i=this.cornerSize;e.save(),e.translate(t,n),e.rotate(fabric.util.degreesToRadians(a.angle)),e.fillStyle="#3b82f6",e.beginPath(),e.arc(0,0,i/2,0,2*Math.PI),e.fill();const l=.2*i;e.drawImage(img,-i/2+l/2,-i/2+l/2,i-l,i-l),e.restore()}function showCustomConfirm(e){return new Promise(t=>{const n=document.createElement("div");n.className="custom-confirm-overlay";const o=document.createElement("div");o.className="custom-confirm-modal";const a=document.createElement("p");a.textContent=e;const i=document.createElement("div");i.className="custom-confirm-buttons";const l=document.createElement("button");l.textContent="确认重置",l.className="confirm-btn-ok";const r=document.createElement("button");r.textContent="取消",r.className="confirm-btn-cancel",i.appendChild(r),i.appendChild(l),o.appendChild(a),o.appendChild(i),n.appendChild(o),document.body.appendChild(n);const s=()=>{n.classList.remove("visible"),setTimeout(()=>{document.body.removeChild(n)},200)};l.onclick=()=>{s(),t(!0)},r.onclick=()=>{s(),t(!1)},setTimeout(()=>{n.classList.add("visible")},10)})}async function resetAll(){await showCustomConfirm("您确定要重置所有内容吗？此操作将重新加载页面，所有未保存的修改都将丢失。")&&(lastResultData?(canvas.clear(),canvas.setBackgroundImage(null),canvas.setOverlayImage(null),canvas.renderAll(),await loadFromAPI(lastResultData)):window.location.reload())}async function resetWithNotQueRen(){lastResultData?(canvas.clear(),canvas.setBackgroundImage(null),canvas.setOverlayImage(null),canvas.renderAll(),await loadFromAPI(lastResultData)):window.location.reload()}function saveState(){if(isLoading||isSavingState)return;isSavingState=!0;const e=JSON.stringify(canvas.toJSON(["id","fabritor_desc","imageBorder","pathAlign","minWidth","splitByGrapheme"]));null===initialState&&(initialState=e),0!==undoStack.length&&undoStack[undoStack.length-1]===e||(undoStack.push(e),redoStack=[]),isSavingState=!1}function handleUndoRedo(e){isLoading=!0;try{const t=JSON.parse(e);t.fabritor_schema_version=3,loadFromJSON(t,!1).finally(()=>{isLoading=!1,canvas.discardActiveObject(),transparentRect=canvas.getObjects().find(e=>"transparent-rect"===e.id),transparentRect||(inpaintingImage&&(inpaintingImage.clipPath=null),finalImage&&(finalImage.clipPath=null)),canvas.renderAll()})}catch(e){console.error("解析历史状态JSON时失败:",e),alert("执行撤销/重做失败！"),isLoading=!1}}function undo(){if(undoStack.length>1){const e=undoStack.pop();redoStack.push(e),handleUndoRedo(undoStack[undoStack.length-1])}}function redo(){if(redoStack.length>0){const e=redoStack.pop();undoStack.push(e),handleUndoRedo(e)}}function addText(){const e=new fabric.FText("请输入文本",{left:canvas.getCenter().left,top:canvas.getCenter().top,originX:"center",originY:"center",width:200,fontSize:16,fontFamily:"Noto Sans SC, sans-serif",fill:"#000000",editable:!1,selectable:!0,hasControls:!0,evented:!0});canvas.add(e),canvas.setActiveObject(e),updateAndShowTextPanel(e),canvas.renderAll(),saveState()}img.src=deleteIcon,fabric.Textbox.prototype.controls.deleteControl=new fabric.Control({x:.5,y:-.5,offsetX:12,offsetY:-12,cursorStyle:"pointer",mouseUpHandler:deleteObject,render:renderDeleteIcon,cornerSize:20}),fabric.FText.prototype.controls.deleteControl=fabric.Textbox.prototype.controls.deleteControl;const fontLoadingPromises=new Map;async function loadFont(e){const t=FONT_LIST.find(t=>t.value===e);if(!t||!t.url)return Promise.resolve();if(fontLoadingPromises.has(e))return fontLoadingPromises.get(e);const n=e,o=new Promise(async(e,o)=>{const a=new FontFace(n,`url(${t.url})`);try{console.log(`%c正在加载字体: ${t.name}...`,"color: blue");const n=await a.load();document.fonts.add(n),console.log(`%c字体 "${t.name}" 加载成功!`,"color: green"),e()}catch(e){console.error(`加载字体 "${t.name}" 失败:`,e),o(e)}});return fontLoadingPromises.set(e,o),o}function hasRect(e){return e.some(e=>"rect"===e.type&&"pictech"!==e.id)}function debugIsNew(e){return e.includes("***")}function debugTopHeight(e){const[t]=e.split("***"),n=t.split("_"),o=new Map;return n.forEach(e=>{const[t,n]=e.match(/([a-z])(\d)/i).slice(1);o.set(t,parseInt(n,10))}),o}function adjustCanvasToSketch(){if(!sketch)return;const e=canvas.width,t=canvas.height,n=sketch.getScaledWidth(),o=sketch.getScaledHeight(),a=.95*Math.min(e/n,t/o);canvas.zoomToPoint(new fabric.Point(canvas.getCenter().left,canvas.getCenter().top),a);const i=sketch.getCenterPoint(),l=canvas.viewportTransform;l[4]=canvas.width/2-i.x*l[0],l[5]=canvas.height/2-i.y*l[3],canvas.setViewportTransform(l),finalImage&&finalImage.set({left:sketch.left,top:sketch.top,scaleX:sketch.scaleX,scaleY:sketch.scaleY}),inpaintingImage&&inpaintingImage.set({left:sketch.left,top:sketch.top,scaleX:sketch.scaleX,scaleY:sketch.scaleY}),finalImageClone&&finalImageClone.set({left:sketch.left,top:sketch.top,scaleX:sketch.scaleX,scaleY:sketch.scaleY}),canvas.renderAll()}let originalTextLayersData=[];async function loadFromJSON(e,t=!0){if(!e)return!1;let n=e;if("string"==typeof e)try{n=JSON.parse(e)}catch(e){return console.error("JSON解析失败:",e),alert("加载模板失败，请检查JSON格式！"),!1}if(3!==n.fabritor_schema_version)return alert("模板版本不兼容，请更换模板！"),!1;isLoading=!0;try{(n.objects||[]).forEach(e=>{"f-text"===e.type&&(e.selectable=!0,e.hasControls=!0,e.evented=!0,e.fontFamily="Noto Sans SC, sans-seri")});const e=canvas.getObjects().filter(e=>"f-text"!==e.type);return new Promise(o=>{canvas.loadFromJSON(n,()=>{const n=canvas.getObjects(),a=n.filter(e=>"f-text"===e.type);canvas.clear(),e.forEach(e=>{canvas.add(e)});const i=canvas.getObjects().find(e=>"final-image"===e.id),l=canvas.getObjects().find(e=>"inpainting-image"===e.id);i&&canvas.sendToBack(i),l&&canvas.bringToFront(l),a.forEach(e=>canvas.add(e));const r=n.find(e=>"pictech"===e.id);r&&(canvas.add(r),canvas.sendToBack(r),sketch=r,sketch.set({selectable:!1,hasControls:!1,evented:!1}),adjustCanvasToSketch()),canvas.requestRenderAll(),t&&(undoStack=[],redoStack=[],saveState()),o(!0)},(e,t)=>{"pictech"===t.id&&(sketch=t)})})}catch(e){return console.error("加载模板时发生严重错误:",e),alert("加载模板时发生严重错误！"),!1}finally{isLoading=!1}}function saveOriginalTextLayers(){originalTextLayersData=[];canvas.getObjects().filter(e=>"f-text"===e.type).forEach(e=>{originalTextLayersData.push({id:e.id,text:e.text,originalText:e.text,fontFamily:e.fontFamily,fontSize:e.fontSize,fill:e.fill,left:e.left,top:e.top,width:e.width,height:e.height,angle:e.angle,scaleX:e.scaleX,scaleY:e.scaleY,originX:e.originX,originY:e.originY,...e.toObject()})})}const RESTORE_TOOL_CONFIG={INITIAL_WIDTH:200,INITIAL_HEIGHT:50,MIN_WIDTH:60,MIN_HEIGHT:24,BUTTON_HEIGHT:16,MIN_HEIGHT_FOR_INTERNAL_BUTTONS:24};let resizeTimeout,confirmBtn=null,cancelBtn=null,masterClipRect=null;async function addTransparentRect(){if(console.log("--- [开始] addTransparentRect: 创建局部恢复工具 (高性能版) ---"),!inpaintingImage||!finalImage)return showCustomAlert("图片未完全加载，无法使用局部恢复功能！"),void console.error("错误: 关键图层 finalImage 或 inpaintingImage 未加载。");restoreGroup&&(console.log("检测到已存在的恢复工具，正在清理..."),cancelRestore(!1));transparentRect=new fabric.Rect({width:RESTORE_TOOL_CONFIG.INITIAL_WIDTH,height:RESTORE_TOOL_CONFIG.INITIAL_HEIGHT,fill:"rgba(0,0,0,0)",strokeWidth:0,originX:"center",originY:"center",left:0,top:0}),[confirmBtn,cancelBtn]=await Promise.all([createIconButton('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"/></svg>',"#10b981","confirm-btn"),createIconButton('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"/></svg>',"#ef4444","cancel-btn")]),restoreGroup=new fabric.Group([transparentRect,confirmBtn,cancelBtn],{left:canvas.getCenter().left,top:canvas.getCenter().top,originX:"center",originY:"center",subTargetCheck:!0,hasControls:!0,lockScalingFlip:!0,transparentCorners:!1,cornerStyle:"circle",cornerColor:"rgba(0,0,255,0.5)",cornerSize:12,borderColor:"red",borderDashArray:[5,5],borderScaleFactor:2}),canvas.add(restoreGroup),canvas.setActiveObject(restoreGroup),canvas.bringToFront(restoreGroup),masterClipRect=_createAbsoluteClipRect(),positionButtons(),bindGroupEvents(),bindButtonEvents(),applyVisualEffects(),canvas.renderAll(),console.log("--- [结束] addTransparentRect: 初始化完成 ---")}function positionButtons(){if(!(restoreGroup&&transparentRect&&confirmBtn&&cancelBtn))return;const e=restoreGroup.scaleX||1,t=restoreGroup.scaleY||1;let n=1,o=1;e<1&&(n=Math.max(e,.8)),t<1&&(o=Math.max(t,.8));let a;if(restoreGroup.getScaledHeight()>=RESTORE_TOOL_CONFIG.MIN_HEIGHT_FOR_INTERNAL_BUTTONS){const e=4;a=transparentRect.height/2-RESTORE_TOOL_CONFIG.BUTTON_HEIGHT/2/t-e/t}else{const e=18;a=transparentRect.height/2+e/t}const i=transparentRect.width/4,l=-i,r=i;cancelBtn.set({left:l,top:a,scaleX:n/e,scaleY:o/t}),confirmBtn.set({left:r,top:a,scaleX:n/e,scaleY:o/t}),confirmBtn.setCoords(),cancelBtn.setCoords(),restoreGroup.setCoords(),canvas.requestRenderAll()}function debounce(e,t){let n;return function(...o){const a=this;clearTimeout(n),n=setTimeout(()=>{e.apply(a,o)},t)}}function bindGroupEvents(){const e=e=>{e&&e.transform&&e.transform.action.includes("scale")&&(restoreGroup.getScaledWidth()<RESTORE_TOOL_CONFIG.MIN_WIDTH&&(restoreGroup.scaleX=RESTORE_TOOL_CONFIG.MIN_WIDTH/transparentRect.width),restoreGroup.getScaledHeight()<RESTORE_TOOL_CONFIG.MIN_HEIGHT&&(restoreGroup.scaleY=RESTORE_TOOL_CONFIG.MIN_HEIGHT/transparentRect.height)),positionButtons(),updateMasterClipRectSize(),applyVisualEffects()};restoreGroup.on("moving",e),restoreGroup.on("scaling",e),restoreGroup.on("rotating",e),restoreGroup.on("modified",()=>{console.log("恢复组被修改 (操作结束)")})}function updateMasterClipRectSize(){if(!restoreGroup||!masterClipRect)return;const e=transparentRect.width*restoreGroup.scaleX,t=transparentRect.height*restoreGroup.scaleY;masterClipRect.set({left:restoreGroup.left,top:restoreGroup.top,width:e,height:t,angle:restoreGroup.angle,scaleX:1,scaleY:1})}function bindButtonEvents(){const e=debounce(confirmRestore,300);confirmBtn.on("mousedown",t=>{t.e.preventDefault(),t.e.stopPropagation(),console.log("%c✓ 确认按钮被点击","color: green; font-weight: bold;"),e()}),cancelBtn.on("mousedown",e=>{e.e.preventDefault(),e.e.stopPropagation(),console.log("%c× 取消按钮被点击","color: red; font-weight: bold;"),cancelRestore()})}function updateMasterClipPath(){restoreGroup&&masterClipRect&&masterClipRect.set({left:restoreGroup.left,top:restoreGroup.top,scaleX:restoreGroup.scaleX,scaleY:restoreGroup.scaleY,angle:restoreGroup.angle})}function applyVisualEffects(){masterClipRect&&(applyImageClipping(masterClipRect),applyTextMask(masterClipRect),canvas.bringToFront(restoreGroup),canvas.requestRenderAll())}function _createAbsoluteClipRect(){if(!restoreGroup||!transparentRect)return null;const e=transparentRect.width*restoreGroup.scaleX,t=transparentRect.height*restoreGroup.scaleY;return new fabric.Rect({left:restoreGroup.left,top:restoreGroup.top,width:e,height:t,scaleX:1,scaleY:1,angle:restoreGroup.angle,originX:"center",originY:"center",absolutePositioned:!0})}function applyTextMask(e){e.setCoords();canvas.getObjects().filter(e=>"group"!==e.type&&((!e.id||!(e.id.includes("btn")||e.id.includes("restore-group")||e.id.includes("transparent-rect")))&&((!e.name||!e.name.includes("btn")&&!e.name.includes("restore"))&&(e!==finalImage&&e!==inpaintingImage&&("f-text"===e.type||"text"===e.type||"i-text"===e.type))))).forEach(t=>{if(t.intersectsWithObject(e,!0,!0)){t.set({selectable:!1,hasControls:!1,evented:!1});const n=new fabric.Rect({left:e.left,top:e.top,width:e.width,height:e.height,angle:e.angle,scaleX:e.scaleX,scaleY:e.scaleY,originX:"center",originY:"center",absolutePositioned:!0,inverted:!0});t.clipPath=n,t.dirty=!0}else t.clipPath&&(t.clipPath=null,t.set({selectable:!0,hasControls:!0,evented:!0}),t.dirty=!0)}),canvas.requestRenderAll()}function updateTransparentRectSize(){if(!restoreGroup||!transparentRect)return;const e=restoreGroup.scaleX||1,t=restoreGroup.scaleY||1,n=transparentRect.width*e,o=transparentRect.height*t;console.log(`透明矩形实际尺寸更新: ${n}x${o} (组缩放: ${e}, ${t})`),transparentRect.set({width:n,height:o,scaleX:1,scaleY:1}),masterClipRect&&masterClipRect.set({left:restoreGroup.left,top:restoreGroup.top,width:n,height:o,scaleX:1,scaleY:1,angle:restoreGroup.angle}),window.currentTransparentRectSize={width:n,height:o,scaleX:e,scaleY:t},transparentRect.setCoords(),masterClipRect&&masterClipRect.setCoords()}function applyImageClipping(e){if(!inpaintingImage||!finalImage)return;const t=fabric.util.object.clone(e);t.inverted=!1;const n=fabric.util.object.clone(e);n.inverted=!0,finalImage.clipPath=t,inpaintingImage.clipPath=n,canvas.bringToFront(finalImage),canvas.bringToFront(restoreGroup),canvas.renderAll()}async function confirmRestore(){if(console.log("%c--- [开始] confirmRestore (消除白痕修复版) ---","color: #4CAF50; font-weight: bold;"),!restoreGroup)return;const e=_createAbsoluteClipRect();if(!e)return void console.error("无法创建裁剪矩形，操作中止。");e.setCoords();const t=canvas.getObjects(),n=t.indexOf(inpaintingImage);if(-1===n)return alert("错误：找不到 inpaintingImage 图层！"),void cancelRestore(!1);const o=t.filter((e,t)=>t>n&&!e.name?.includes("restore")&&e!==restoreGroup).filter(t=>{if(t.setCoords(),!t.visible)return!1;return("f-text"===t.type||"text"===t.type||"i-text"===t.type)&&t.intersectsWithObject(e,!0,!0)}),a=canvas.toJSON(["id","selectable","evented","clipPath"]),i=new Map;[inpaintingImage,finalImage].forEach(e=>{e.clipPath&&(i.set(e,e.clipPath),e.clipPath=null)});try{const t=[inpaintingImage,finalImage],a=await new Promise(e=>{fabric.util.enlivenObjects(t.map(e=>e.toJSON()),e)}),i=new fabric.Group(a),l=i.getBoundingRect(!0);i.destroy(),console.log("[步骤 2] 计算出合成区域的精确边界 (bBox):",l);const r=window.devicePixelRatio||2,s=document.createElement("canvas");s.width=Math.ceil(l.width*r),s.height=Math.ceil(l.height*r);const c=new fabric.StaticCanvas(s,{width:Math.ceil(l.width*r),height:Math.ceil(l.height*r),enableRetinaScaling:!1});console.log(`[步骤 3] 创建离屏画布，尺寸: ${c.width}x${c.height}px, 倍率: ${r}`);const g=(await new Promise(e=>fabric.util.enlivenObjects([inpaintingImage.toJSON()],e)))[0];g.left-=l.left,g.top-=l.top,c.add(g),console.log("[步骤 4.1] 已将完整的 inpaintingImage (无裁剪) 作为底图添加到离屏画布");const d=(await new Promise(e=>fabric.util.enlivenObjects([finalImage.toJSON()],e)))[0];d.left-=l.left,d.top-=l.top;const p=new fabric.Rect({left:e.left-l.left,top:e.top-l.top,width:transparentRect.width,height:transparentRect.height,scaleX:restoreGroup.scaleX,scaleY:restoreGroup.scaleY,angle:restoreGroup.angle,originX:"center",originY:"center",absolutePositioned:!0,inverted:!1});if(d.clipPath=p,c.add(d),console.log("[步骤 4.2] 已将裁剪后的 finalImage (框内部分) 覆盖到底图之上"),o.length>0){(await new Promise(e=>{fabric.util.enlivenObjects(o.map(e=>e.toJSON()),e)})).forEach(t=>{t.left-=l.left,t.top-=l.top;const n=new fabric.Rect({left:e.left-l.left,top:e.top-l.top,width:transparentRect.width,height:transparentRect.height,scaleX:restoreGroup.scaleX,scaleY:restoreGroup.scaleY,angle:restoreGroup.angle,originX:"center",originY:"center",absolutePositioned:!0,inverted:!0});t.clipPath=n,c.add(t)}),console.log(`[步骤 4.3] 已将 ${o.length} 个其他图层（框外文字）添加到离屏画布`)}c.setViewportTransform([r,0,0,r,0,0]),c.renderAll();const u=c.toDataURL({format:"png",quality:1}),f=await new Promise((e,t)=>{fabric.Image.fromURL(u,n=>{n?e(n):t(new Error("无法创建合并图像"))},{crossOrigin:"anonymous"})});f.set({left:l.left,top:l.top,originX:"left",originY:"top",id:"inpainting-image",selectable:!1,evented:!1,scaleX:1/r,scaleY:1/r}),canvas.renderOnAddRemove=!1;[inpaintingImage,finalImage,...o].forEach(e=>canvas.remove(e)),canvas.insertAt(f,n,!1),inpaintingImage=f,cancelRestore(!1),canvas.renderOnAddRemove=!0,c.dispose(),s.remove(),canvas.renderAll(),console.log("%c--- confirmRestore 操作成功结束，白痕问题已修复 ---","color: #4CAF50; font-weight: bold;"),undoStack=[],redoStack=[],saveState()}catch(e){console.error("确认恢复时发生严重错误:",e),alert("确认恢复时发生严重错误，操作已回滚！"),canvas.loadFromJSON(a,()=>{inpaintingImage=canvas.getObjects().find(e=>"inpainting-image"===e.id),finalImage=canvas.getObjects().find(e=>"final-image"===e.id),canvas.renderAll()})}finally{if(i.size>0){for(const[e,t]of i.entries())canvas.getObjects().includes(e)&&(e.clipPath=t);canvas.renderOnAddRemove&&canvas.renderAll()}}}function cancelRestore(e=!0){transparentRect&&(canvas.remove(transparentRect),transparentRect=null),console.log("--- [开始] cancelRestore: 撤销操作 ---"),restoreGroup&&(canvas.remove(restoreGroup),restoreGroup=null,confirmBtn=null,cancelBtn=null),masterClipRect=null;const t=canvas.getObjects().find(e=>"final-image"===e.id),n=canvas.getObjects().find(e=>"inpainting-image"===e.id),o=canvas.getObjects().find(e=>"pictech"===e.id);t&&canvas.sendToBack(t),o&&canvas.sendToBack(o),n&&canvas.bringToFront(n),canvas.getObjects().forEach(e=>{e.clipPath&&(e.clipPath=null,e.dirty=!0),"f-text"===e.type&&(e.set({selectable:!0,hasControls:!0,evented:!0}),canvas.bringToFront(e))}),canvas.requestRenderAll(),console.log("--- [结束] cancelRestore: 状态已恢复 ---")}function showCustomAlert(e){console.warn(`UI提示: ${e}`)}async function createIconButton(e,t,n,o=24){const a=o/2,i=new fabric.Circle({radius:a,fill:"rgba(20, 20, 30, 0.7)",stroke:t,strokeWidth:2,shadow:`0 0 10px ${t}`,originX:"center",originY:"center"}),l=await new Promise(t=>{fabric.loadSVGFromString(e,(e,n)=>{const o=fabric.util.groupSVGElements(e,n);o.set({fill:"#ffffff",originX:"center",originY:"center"});const i=1.2*a/Math.max(o.width,o.height);o.scale(i),t(o)})});return new fabric.Group([i,l],{name:n,selectable:!1,hasControls:!1,evented:!0,originX:"center",originY:"center",hoverCursor:"pointer"})}function resizeCanvas(){const e=document.getElementById("canvas-container"),t=e.clientWidth,n=e.clientHeight;canvas.setWidth(t),canvas.setHeight(n),canvas.calcOffset(),canvas.renderAll()}function positionTextPanel(e){console.group(`[Debug] 定位面板，目标文本: "${e?.text?.substring(0,20)||"未知"}..."`);try{if(!e||!e.type||"function"!=typeof e.getBoundingRect)return console.error("【错误】无效的 target 对象:",{target:e,hasType:!!e?.type,isFabricObject:e instanceof fabric.Object,hasGetBoundingRect:"function"==typeof e?.getBoundingRect}),void console.groupEnd();requestAnimationFrame(()=>{requestAnimationFrame(()=>{performPositioning(e)})})}catch(e){console.error("在 positionTextPanel 函数中发生异常:",e),console.groupEnd()}}function performPositioning(e){try{console.log("%c目标文本属性:","color: purple; font-weight: bold;",{type:e.type,text:e.text,width:e.width,height:e.height,scaleX:e.scaleX,scaleY:e.scaleY,angle:e.angle,left:e.left,top:e.top,fontSize:e.get("fontSize")||24});const t=textEditorPanel;if("true"===t.dataset.userDragged)return console.log("%c面板已被用户拖拽，跳过自动定位","color: orange; font-weight: bold;"),void console.groupEnd();const n=document.getElementById("editor-container");n.offsetHeight;const o=getPanelRect(t);if(!o)return console.error("【错误】无法获取面板的有效尺寸!"),void console.groupEnd();console.log("%c面板尺寸:","color: blue; font-weight: bold;",o),setTimeout(()=>{calculateAndApplyPosition(e,t,n,o)},10)}catch(e){console.error("在 performPositioning 函数中发生异常:",e),console.groupEnd()}}function getPanelRect(e){const t="none"===e.style.display,n=e.style.visibility,o=e.style.position;t&&(e.style.visibility="hidden",e.style.position="absolute",e.style.display="block",e.style.top="-9999px"),e.offsetHeight;const a=e.getBoundingClientRect();return t&&(e.style.display="none",e.style.visibility=n,e.style.position=o,e.style.top=""),0===a.width||0===a.height?null:{width:a.width,height:a.height}}async function calculateAndApplyPosition(e,t,n,o){try{let a=null,i=0;const l=3;for(;i<l;){const e=n.getBoundingClientRect();if(a&&Math.abs(e.width-a.width)<1&&Math.abs(e.height-a.height)<1)break;a=e,i++,i<l&&await new Promise(e=>setTimeout(e,5))}console.log("%c容器尺寸 (稳定后):","color: blue; font-weight: bold;",{width:a.width,height:a.height,attempts:i}),console.log("%c画布缩放状态:","color: orange; font-weight: bold;",{zoom:canvas.getZoom(),viewportTransform:canvas.viewportTransform});const r=canvas.getElement().getBoundingClientRect(),s=e.getBoundingRect(),c={left:r.left+s.left,top:r.top+s.top,width:s.width,height:s.height},g={left:c.left-a.left,top:c.top-a.top,width:c.width,height:c.height};console.log("%c【修复】目标文本在各坐标系中的位置:","color: green; font-weight: bold;",{"canvas坐标":s,"屏幕坐标":c,"容器相对坐标":g});const d=e.get("fontSize")||24,p=Math.min(a.width/1200,a.height/800),u=Math.max(15,20*p),f={bottom:u+10+.3*d,top:u+60+.4*d,right:u+.3*d,left:u+.3*d};console.log("%c动态间距 (容器自适应):","color: cyan; font-weight: bold;",{...f,fontSize:d,containerScale:p.toFixed(3),baseGap:u.toFixed(2)});const h=g.top+g.height,m=g.left+g.width,v=g.left+g.width/2,b=g.top+g.height/2,y={bottom:{top:h+f.bottom,left:v-o.width/2},top:{top:g.top-o.height-f.top,left:v-o.width/2},right:{top:b-o.height/2,left:m+f.right},left:{top:b-o.height/2,left:g.left-o.width-f.left}};console.log("%c【修复后】候选位置:","color: cyan; font-weight: bold;",y);const S=["bottom","top","right","left"];let w=null;for(const e of S){const t=y[e],n=10,i=t.top>=n&&t.left>=n&&t.top+o.height<=a.height-n&&t.left+o.width<=a.width-n,l=5,r=t.left<g.left+g.width+l&&t.left+o.width>g.left-l&&t.top<g.top+g.height+l&&t.top+o.height>g.top-l;if(console.log(`%c检查位置 '${e}':`,i&&!r?"color: green;":"color: red;",{fitsContainer:i,overlapsText:r,position:t,gap:f["bottom"===e?"bottom":"top"===e?"top":"right"===e?"right":"left"].toFixed(2)}),i&&!r){console.log(`✔ '${e}' 位置合适，已选择。`),w=t;break}}w?(t.style.top=`${Math.round(w.top)}px`,t.style.left=`${Math.round(w.left)}px`,console.log("%c最终位置:","color: green; font-weight: bold;",{top:Math.round(w.top),left:Math.round(w.left)})):applyFallbackPosition(t,g,a,o,f)}catch(e){console.error("在 calculateAndApplyPosition 函数中发生异常:",e)}finally{console.groupEnd()}}function applyFallbackPosition(e,t,n,o,a){console.warn("【备用方案】使用智能回退定位");let i=t.top+t.height+a.bottom,l=t.left;i+o.height>n.height-10&&(i=Math.max(10,t.top-o.height-a.top)),l=t.left+t.width/2-o.width/2,l=Math.max(10,Math.min(l,n.width-o.width-10)),i=Math.max(10,Math.min(i,n.height-o.height-10)),e.style.top=`${Math.round(i)}px`,e.style.left=`${Math.round(l)}px`,console.log("%c回退位置:","color: orange; font-weight: bold;",{top:Math.round(i),left:Math.round(l)})}function updateAndShowTextPanel(e){if(!e||"f-text"!==e.type)return console.log("【Debug】目标无效或非 f-text，隐藏面板:",{target:e,type:e?.type}),void hideTextPanel();if(e===lastActiveText)return console.log("%c同一文本对象且面板已被拖拽，跳过定位","color: orange; font-weight: bold;",{targetText:e.text,lastActiveText:lastActiveText?.text}),textEditorPanel.style.display="block",textEditorPanel.style.opacity="1",textEditorPanel.style.transform="translateY(0)",textContentInput.focus(),void console.log("【Debug】文本编辑面板成功显示，目标文本:",e.text);e&&"f-text"==e.type&&(lastActiveText=e),textContentInput.value=e.get("text")||"",fontSizeInput.value=Math.round(e.get("fontSize"))||24,lineHeightInput.value=e.get("lineHeight")||1.3,fontColorInput.value=e.get("fill")||"#000000",colorPreview.style.backgroundColor=e.get("fill")||"#000000";let t=e.get("fontFamily")||"Noto Sans SC, sans-serif";FONT_LIST.some(e=>e.value===t)||(console.warn(`字体 "${t}" 未在列表中找到，回退到默认字体。`),t="Noto Sans SC, sans-serif"),fontFamilySelect.value=t,boldBtn.classList.toggle("active","bold"===e.get("fontWeight")),alignCenterBtn.classList.toggle("active","center"===e.get("textAlign"));const n=document.getElementById("color-picker-icon1");isLightColor(fontColorInput.value.toLowerCase())?n.setAttribute("fill","#000000"):n.setAttribute("fill","#ffffff"),fontFamilySelect.value&&FONT_LIST.some(e=>e.value===fontFamilySelect.value)||(fontFamilySelect.value="AlibabaPuHuiTi",applyStyleToSelection({fontFamily:"AlibabaPuHuiTi"})),textEditorPanel.style.display="block",textEditorPanel.style.opacity="0",positionTextPanel(e),setTimeout(()=>{canvas.getActiveObject()===e?(textEditorPanel.style.opacity="1",textEditorPanel.style.transform="translateY(0)",textContentInput.focus(),console.log("【Debug】文本编辑面板成功显示，目标文本:",e.text)):(console.warn("【Debug】活跃对象已改变，取消显示文本编辑面板"),hideTextPanel())},100)}function isLightColor(e){let t,n,o;3===(e=e.replace(/^#/,"")).length&&(e=e.split("").map(e=>e+e).join("")),t=parseInt(e.slice(0,2),16),n=parseInt(e.slice(2,4),16),o=parseInt(e.slice(4,6),16);return(299*t+587*n+114*o)/1e3>=200}function hideTextPanel(){textEditorPanel.style.opacity="0",textEditorPanel.style.transform="translateY(10px)",setTimeout(()=>{textEditorPanel.style.display="none"},200)}function hideTextPanelAndDeselect(){hideTextPanel(),canvas.discardActiveObject(),canvas.renderAll()}function applyStyleToSelection(e){const t=canvas.getActiveObject();if(t&&"f-text"===t.type){console.log("%c[applyStyleToSelection] 选中对象前状态:","color: #0aa",{...t.toObject()}),console.log("%c[applyStyleToSelection] 即将应用样式:","color: #0a0",e),t.set(e),canvas.renderAll(),console.log("%c[applyStyleToSelection] 样式应用后状态:","color: #00a",{...t.toObject()});const n="block"===textEditorPanel.style.display&&"1"===textEditorPanel.style.opacity;console.log(`[applyStyleToSelection] 面板当前是否显示: ${n}`),n?(console.log("[applyStyleToSelection] 面板已显示，仅更新控件值"),textContentInput.value=t.get("text")||"",fontSizeInput.value=Math.round(t.get("fontSize"))||24,lineHeightInput.value=t.get("lineHeight")||1.3,fontColorInput.value=t.get("fill")||"#000000",colorPreview.style.backgroundColor=t.get("fill")||"#000000",boldBtn.classList.toggle("active","bold"===t.get("fontWeight")),alignCenterBtn.classList.toggle("active","center"===t.get("textAlign")),console.log("[applyStyleToSelection] ✅ 已完成控件值更新")):(console.log("[applyStyleToSelection] 面板未显示，调用 updateAndShowTextPanel()"),updateAndShowTextPanel(t))}else console.warn("[applyStyleToSelection] 未选中 f-text 对象，或对象无效")}function setupTextControlListeners(){textContentInput.addEventListener("input",e=>{const t=canvas.getActiveObject();t&&"f-text"===t.type&&(t.set("text",e.target.value),canvas.renderAll(),positionTextPanel(t))}),textContentInput.addEventListener("blur",saveState),fontFamilySelect.addEventListener("change",async e=>{await loadFont(e.target.value),applyStyleToSelection({fontFamily:e.target.value}),saveState()}),fontColorInput.addEventListener("change",e=>{applyStyleToSelection({fill:e.target.value}),colorPreview.style.backgroundColor=e.target.value,saveState()}),fontSizeInput.addEventListener("change",e=>{applyStyleToSelection({fontSize:parseInt(e.target.value,10)||24}),saveState()}),lineHeightInput.addEventListener("change",e=>{applyStyleToSelection({lineHeight:parseFloat(e.target.value)||1.3}),saveState()}),boldBtn.addEventListener("click",()=>{const e=canvas.getActiveObject();e&&(applyStyleToSelection({fontWeight:"bold"===e.get("fontWeight")?"normal":"bold"}),saveState())}),alignCenterBtn.addEventListener("click",()=>{const e=canvas.getActiveObject();e&&(applyStyleToSelection({textAlign:"center"===e.get("textAlign")?"left":"center"}),saveState())}),fontSizeInput.addEventListener("input",e=>applyStyleToSelection({fontSize:parseInt(e.target.value,10)||24})),lineHeightInput.addEventListener("input",e=>applyStyleToSelection({lineHeight:parseFloat(e.target.value)||1.3})),fontColorInput.addEventListener("input",e=>{applyStyleToSelection({fill:e.target.value}),colorPreview.style.backgroundColor=e.target.value})}function setupPanelDragListeners(){const e=document.getElementById("text-editor-panel");e.addEventListener("mousedown",t=>{if("INPUT"===t.target.tagName||"SELECT"===t.target.tagName||"BUTTON"===t.target.tagName)return;isDraggingPanel=!0,panelStartX=t.clientX,panelStartY=t.clientY;const n=getComputedStyle(e);panelLeft=parseFloat(n.left),panelTop=parseFloat(n.top)}),document.addEventListener("mousemove",t=>{if(!isDraggingPanel)return;const n=t.clientX-panelStartX,o=t.clientY-panelStartY;e.style.left=`${panelLeft+n}px`,e.style.top=`${panelTop+o}px`}),document.addEventListener("mouseup",()=>{isDraggingPanel=!1})}window.addEventListener("resize",resizeCanvas),window.addEventListener("resize",()=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout(()=>{const e=canvas.getActiveObject();e&&"f-text"===e.type&&"none"!==textEditorPanel.style.display&&(console.log("窗口大小变化，重新定位面板"),positionTextPanel(e))},100)});let isPanMode=!1;canvas.off("mouse:down").on("mouse:down",function(e){const t=e.target,n=e.e;return t&&"f-text"===t.type?(updateAndShowTextPanel(t),isPanMode=!1,void(isDragging=!1)):t&&t.selectable?(isPanMode=!1,void(isDragging=!1)):(canvas.discardActiveObject(),hideTextPanel(),isPanMode=!0,isDragging=!1,lastPosX=n.clientX,void(lastPosY=n.clientY))}),canvas.off("mouse:move").on("mouse:move",function(e){if(!isPanMode&&!isDragging)return;const t=e.e,n=t.clientX-lastPosX,o=t.clientY-lastPosY;if(isPanMode)canvas.relativePan(new fabric.Point(n,o));else if(isDragging&&canvas.getActiveObject()){const e=canvas.getActiveObject();"f-text"===e.type&&e.isEditing&&(e.lockMovementX=!1,e.lockMovementY=!1),e.left+=n,e.top+=o,e.setCoords(),"f-text"===e.type&&positionTextPanel(e)}lastPosX=t.clientX,lastPosY=t.clientY,canvas.requestRenderAll()}),canvas.off("mouse:up").on("mouse:up",function(){const e=canvas.getActiveObject();e&&"f-text"===e.type&&e.isEditing&&((isDragging||isPanMode)&&saveState(),e.lockMovementX=!0,e.lockMovementY=!0),isDragging=!1,isPanMode=!1}),canvas.on("mouse:wheel",e=>{const t=e.e.deltaY;let n=canvas.getZoom();n*=.999**t,n>5&&(n=5),n<.1&&(n=.1),canvas.zoomToPoint({x:e.e.offsetX,y:e.e.offsetY},n),e.e.preventDefault(),e.e.stopPropagation(),canvas.requestRenderAll(),clearTimeout(window.saveStateTimeout),window.saveStateTimeout=setTimeout(saveState,300)}),canvas.on({"selection:created":e=>{e.target&&"f-text"===e.target.type?updateAndShowTextPanel(e.target):setTimeout(()=>{canvas.getActiveObject()||hideTextPanel()},100)},"selection:updated":e=>{e.target&&"f-text"===e.target.type?updateAndShowTextPanel(e.target):setTimeout(()=>{canvas.getActiveObject()||hideTextPanel()},100)},"selection:cleared":()=>{setTimeout(()=>{canvas.getActiveObject()||(hideTextPanel(),console.log("【Debug】选择清空，隐藏文本编辑面板"))},100)},"mouse:up":()=>{isDragging=!1}}),document.addEventListener("keydown",e=>{"Delete"===e.key&&"restore-group"===canvas.getActiveObject()?.id&&cancelRestore()});